<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Generator - T·ª± ƒê·ªông T·∫°o B√†i T·∫≠p</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .option-btn { transition: all 0.2s; }
        .option-btn:disabled { cursor: not-allowed; opacity: 0.9; }
        .correct {
            background-color: #dcfce7 !important; 
            border-color: #22c55e !important;
            color: #15803d; 
            font-weight: 600;
        }
        .incorrect {
            background-color: #fee2e2 !important; 
            border-color: #ef4444 !important;
            color: #b91c1c; 
            font-weight: 600;
        }
        .tf-input { display: none; }
        .tf-label {
            cursor: pointer; 
            padding: 0.75rem 1.5rem; 
            border: 1px solid #d1d5db;
            border-radius: 0.5rem; 
            transition: all 0.2s;
        }
        .tf-input:checked + .tf-label {
            background-color: #dbeafe; 
            border-color: #3b82f6; 
            font-weight: 600;
        }
        .quiz-card {
            background-color: white; 
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem; 
            padding: 1.5rem;
        }
        .input-section {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- HEADER + TABS - STICKY -->
        <div class="sticky top-0 z-50 bg-gradient-to-r from-purple-600 to-blue-600 pb-3">
            <!-- Header -->
            <div class="text-center mb-3 pt-3">
                <h1 class="text-2xl md:text-3xl font-bold text-white">
                    <i class="fas fa-magic"></i> Quiz Generator
                </h1>
            </div>

            <!-- Tabs -->
            <div class="flex gap-2 flex-wrap justify-center">
                <button id="tab-input" class="tab-btn active bg-white text-gray-700 text-sm py-2 px-3">
                    <i class="fas fa-keyboard"></i> Nh·∫≠p D·ªØ Li·ªáu
                </button>
                <button id="tab-saved" class="tab-btn bg-white bg-opacity-20 text-white text-sm py-2 px-3">
                    <i class="fas fa-folder-open"></i> L∆∞u Data
                </button>
                <button id="tab-quiz" class="tab-btn bg-white bg-opacity-20 text-white text-sm py-2 px-3">
                    <i class="fas fa-graduation-cap"></i> L√†m B√†i T·∫≠p
                </button>
                <button id="tab-wrong" class="tab-btn bg-white bg-opacity-20 text-white text-sm py-2 px-3">
                    <i class="fas fa-exclamation-triangle"></i> C√¢u Hay Sai
                </button>
                <button id="tab-redo" class="tab-btn bg-white bg-opacity-20 text-white text-sm py-2 px-3">
                    <i class="fas fa-redo"></i> L√†m L·∫°i C√¢u Sai
                </button>
            </div>
        </div>

        <!-- MAIN CONTENT -->

        <!-- Tab 1: Input Section -->
        <div id="panel-input" class="input-section p-6 md:p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-edit"></i> Nh·∫≠p D·ªØ Li·ªáu C√¢u H·ªèi
            </h2>

            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">T√™n M√¥n H·ªçc:</label>
                <input type="text" id="subject-name" 
                    class="w-full p-3 border-2 border-gray-300 rounded-lg"
                    placeholder="V√≠ d·ª•: L·ªãch S·ª≠ 6, ƒê·ªãa L√≠ 6, KHTN 6...">
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">D√°n d·ªØ li·ªáu v√†o ƒë√¢y:</label>
                <textarea id="input-data" 
                    class="w-full h-96 p-4 border-2 border-gray-300 rounded-lg font-mono text-sm resize-y"
                    placeholder="Paste code JavaScript ho·∫∑c text..."></textarea>
            </div>

            <div class="flex gap-3 flex-wrap">
                <button id="btn-parse" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all">
                    <i class="fas fa-cogs"></i> Ph√¢n T√≠ch & T·∫°o Quiz
                </button>
                <button id="btn-clear" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all">
                    <i class="fas fa-trash"></i> X√≥a
                </button>
            </div>

            <div id="parse-result" class="mt-4 hidden">
                <div class="bg-green-50 border-l-4 border-green-500 p-4">
                    <p class="font-semibold text-green-900">‚úÖ Th√†nh c√¥ng!</p>
                    <p class="text-green-800 text-sm mt-1" id="parse-stats"></p>
                </div>
            </div>
        </div>

        <!-- Tab 2: Quiz Section -->
        <div id="panel-quiz" class="input-section p-6 md:p-8 hidden">
            <!-- HEADER + TI·∫æN ƒê·ªò - STICKY -->
            <div class="sticky top-[100px] z-10 bg-white pb-3 mb-4 shadow-md">
                <div class="flex justify-between items-center mb-2 flex-wrap gap-2 pt-2">
                    <h2 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-graduation-cap"></i> B√†i T·∫≠p
                    </h2>
                    <div class="flex gap-2">
                        <button id="btn-shuffle" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-1.5 px-3 rounded text-sm">
                            <i class="fas fa-random"></i> X√°o tr·ªôn
                        </button>
                        <button id="btn-reset" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-1.5 px-3 rounded text-sm">
                            <i class="fas fa-sync-alt"></i> Reset
                        </button>
                    </div>
                </div>

                <!-- KHUNG TI·∫æN ƒê·ªò -->
                <div class="bg-gradient-to-r from-blue-50 to-green-50 p-2.5 rounded border border-blue-300">
                    <span id="progress-text" class="text-sm font-semibold text-gray-700">ƒê√£ ho√†n th√†nh: 0 / 0 | C√¢u sai: 0</span>
                </div>
            </div>

            <div id="quiz-container">
                <p class="text-center text-gray-500 italic">Ch∆∞a c√≥ c√¢u h·ªèi.</p>
            </div>
        </div>

        <!-- Tab 2: Saved Data -->
        <div id="panel-saved" class="input-section p-6 md:p-8 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-folder-open"></i> C√°c M√¥n ƒê√£ L∆∞u
            </h2>
            
            <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4 flex justify-between items-center">
                <p class="text-sm font-medium text-green-900">
                    üìö T·ªïng c·ªông: <strong id="saved-count" class="text-green-600">0</strong> m√¥n h·ªçc
                </p>
                <button id="btn-backup" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
                    <i class="fas fa-download"></i> T·∫£i Backup
                </button>
            </div>
            
            <div id="saved-container" class="space-y-3">
                <p class="text-center text-gray-500 italic">Ch∆∞a c√≥ m√¥n n√†o ƒë∆∞·ª£c l∆∞u.</p>
            </div>
        </div>

        <!-- Tab 3: Wrong History -->
        <div id="panel-wrong" class="input-section p-6 md:p-8 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-exclamation-triangle"></i> Nh·ªØng C√¢u Hay Sai
            </h2>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                <p class="text-sm font-medium text-blue-900 mb-2">
                    ƒê√¢y l√† danh s√°ch <strong id="wrong-count" class="text-red-600">0</strong> c√¢u b·∫°n ƒë√£ t·ª´ng l√†m sai.
                </p>
                <button id="btn-clear-history" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow transition">
                    <i class="fas fa-trash-alt"></i> X√≥a L·ªãch S·ª≠
                </button>
            </div>
            
            <div id="wrong-container">
                <p class="text-center text-gray-500 italic">Ch∆∞a c√≥ c√¢u n√†o sai.</p>
            </div>
        </div>

        <!-- Tab 4: Redo Wrong Answers -->
        <div id="panel-redo" class="input-section p-6 md:p-8 hidden">
            <!-- HEADER + TI·∫æN ƒê·ªò - STICKY -->
            <div class="sticky top-[100px] z-10 bg-white pb-3 mb-4 shadow-md">
                <div class="flex justify-between items-center mb-2 flex-wrap gap-2 pt-2">
                    <h2 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-redo"></i> L√†m L·∫°i C√¢u Sai
                    </h2>
                    <div class="flex gap-2">
                        <button id="btn-shuffle-redo" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-1.5 px-3 rounded text-sm">
                            <i class="fas fa-random"></i> X√°o tr·ªôn
                        </button>
                        <button id="btn-reset-redo" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-1.5 px-3 rounded text-sm">
                            <i class="fas fa-sync-alt"></i> Reset
                        </button>
                    </div>
                </div>

                <!-- KHUNG TI·∫æN ƒê·ªò -->
                <div class="bg-gradient-to-r from-blue-50 to-green-50 p-2.5 rounded border border-blue-300">
                    <span id="progress-text-redo" class="text-sm font-semibold text-gray-700">ƒê√£ ho√†n th√†nh: 0 / 0 | C√¢u sai: 0</span>
                </div>
            </div>

            <div id="quiz-container-redo">
                <p class="text-center text-gray-500 italic">Ch∆∞a c√≥ c√¢u sai ƒë·ªÉ l√†m l·∫°i.</p>
            </div>
        </div>
    </div>

    <script>
        let quizData = [];
        let originalQuizData = []; // L∆∞u b·∫£n g·ªëc ƒë·ªÉ reset
        let questionStatus = [];
        let selectedAnswers = []; // L∆ØU ƒê√ÅP √ÅN ƒê√É CH·ªåN
        let wrongHistory = new Set(); // L∆∞u index c√¢u sai
        let redoQuiz = null;
        let currentSubject = ''; // T√™n m√¥n ƒëang l√†m
        
        // GITHUB CONFIG (ƒê·ªÉ tr·ªëng = ch·ªâ d√πng localStorage)
        const GITHUB_TOKEN = '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';
        const GITHUB_REPO = 'luckat224/Quiz-Generator-Sync';
        const GITHUB_BRANCH = 'main';

        function showTab(tabName) {
            console.log('üîÑ Chuy·ªÉn sang tab:', tabName);
            
            document.getElementById('panel-input').classList.add('hidden');
            document.getElementById('panel-saved').classList.add('hidden');
            document.getElementById('panel-quiz').classList.add('hidden');
            document.getElementById('panel-wrong').classList.add('hidden');
            document.getElementById('panel-redo').classList.add('hidden');

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('bg-white', 'bg-opacity-20', 'text-white');
            });

            document.getElementById(`panel-${tabName}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.add('active');
            activeBtn.classList.remove('bg-white', 'bg-opacity-20', 'text-white');

            if (tabName === 'saved') {
                renderSavedSubjects();
            } else if (tabName === 'quiz') {
                console.log('üìù Render quiz v·ªõi', quizData.length, 'c√¢u');
                renderQuiz();
            } else if (tabName === 'wrong') {
                renderWrongHistory();
            } else if (tabName === 'redo') {
                renderRedoQuiz();
            }
        }
        
        function renderSavedSubjects() {
            console.log('üé® RENDER SAVED SUBJECTS...');
            const container = document.getElementById('saved-container');
            const subjects = JSON.parse(localStorage.getItem('savedSubjects') || '{}');
            const count = Object.keys(subjects).length;
            
            console.log('üìä C√≥', count, 'm√¥n h·ªçc:', Object.keys(subjects));
            
            document.getElementById('saved-count').textContent = count;
            container.innerHTML = '';
            
            if (count === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 italic">Ch∆∞a c√≥ m√¥n n√†o ƒë∆∞·ª£c l∆∞u.</p>';
                return;
            }
            
            Object.keys(subjects).forEach(subjectName => {
                console.log('‚ûï T·∫°o card cho m√¥n:', subjectName);
                
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg border-2 border-gray-200 hover:border-blue-500 cursor-pointer transition-all flex justify-between items-center';
                
                const info = document.createElement('div');
                info.className = 'flex-1 cursor-pointer';
                info.onclick = () => {
                    console.log('üñ±Ô∏è CLICK V√ÄO M√îN:', subjectName);
                    loadSubject(subjectName);
                };
                info.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-800">üìö ${subjectName}</h3>
                    <p class="text-sm text-gray-600">${subjects[subjectName].length} c√¢u h·ªèi</p>
                `;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.onclick = (e) => {
                    console.log('üóëÔ∏è CLICK X√ìA M√îN:', subjectName);
                    e.stopPropagation();
                    if (confirm(`X√≥a m√¥n "${subjectName}"?`)) {
                        delete subjects[subjectName];
                        localStorage.setItem('savedSubjects', JSON.stringify(subjects));
                        renderSavedSubjects();
                    }
                };
                
                card.appendChild(info);
                card.appendChild(deleteBtn);
                container.appendChild(card);
            });
            
            console.log('‚úÖ Render xong', count, 'cards');
        }
        
        function loadSubject(subjectName) {
            console.log('üîµ Click v√†o m√¥n:', subjectName);
            
            const subjects = JSON.parse(localStorage.getItem('savedSubjects') || '{}');
            console.log('üìÇ Danh s√°ch m√¥n:', Object.keys(subjects));
            
            if (!subjects[subjectName]) {
                alert('M√¥n h·ªçc kh√¥ng t·ªìn t·∫°i!');
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y m√¥n:', subjectName);
                return;
            }
            
            currentSubject = subjectName;
            quizData = subjects[subjectName];
            originalQuizData = JSON.parse(JSON.stringify(quizData));
            localStorage.setItem('originalQuizData', JSON.stringify(originalQuizData));
            
            console.log('‚úÖ Loaded:', quizData.length, 'c√¢u h·ªèi');
            console.log('üìù C√¢u ƒë·∫ßu ti√™n:', quizData[0]);
            
            localStorage.setItem('quizData', JSON.stringify(quizData));
            
            // CH·ªà RESET TI·∫æN ƒê·ªò N·∫æU LOAD M√îN M·ªöI (kh√°c m√¥n hi·ªán t·∫°i)
            const previousSubject = localStorage.getItem('currentSubject');
            if (previousSubject !== subjectName) {
                console.log('üÜï Load m√¥n m·ªõi, reset ti·∫øn ƒë·ªô');
                questionStatus = new Array(quizData.length).fill(null);
                selectedAnswers = new Array(quizData.length).fill(null);
                localStorage.removeItem('quizProgress');
                localStorage.removeItem('selectedAnswers');
                wrongHistory.clear();
                localStorage.removeItem('wrongHistory');
            } else {
                console.log('‚ôªÔ∏è Load l·∫°i m√¥n ƒëang l√†m, gi·ªØ nguy√™n ti·∫øn ƒë·ªô');
            }
            
            localStorage.setItem('currentSubject', subjectName);
            
            console.log('üìñ ƒê√£ load m√¥n:', subjectName, '(' + quizData.length + ' c√¢u)');
            console.log('ÔøΩ Chuy·ªÉn sang tab Quiz v√† render...');
            
            // ƒê·∫£m b·∫£o chuy·ªÉn tab V√Ä render
            showTab('quiz');
        }

        // Th√™m originalIndex ƒë·ªÉ track c√¢u sai
        function addOriginalIndex(questions) {
            return questions.map((q, idx) => ({
                ...q,
                originalIndex: idx
            }));
        }

        function parseQuizData(text) {
            console.log('üîç B·∫Øt ƒë·∫ßu ph√¢n t√≠ch...');
            console.log('üìÑ D·ªØ li·ªáu g·ªëc (50 k√Ω t·ª± ƒë·∫ßu):', text.substring(0, 50));
            
            let trimmedText = text.trim();
            
            // B∆∞·ªõc 1: Lo·∫°i b·ªè comments
            console.log('üìù Lo·∫°i b·ªè comments...');
            trimmedText = trimmedText.split('\n').map(line => {
                const idx = line.indexOf('//');
                if (idx !== -1) {
                    const before = line.substring(0, idx);
                    const sq = (before.match(/'/g) || []).length;
                    const dq = (before.match(/"/g) || []).length;
                    if (sq % 2 === 0 && dq % 2 === 0) return before;
                }
                return line;
            }).join('\n');
            
            // B∆∞·ªõc 2: X·ª≠ l√Ω JavaScript format
            if (trimmedText.includes("type:")) {
                console.log('‚úÖ Ph√°t hi·ªán format JavaScript');
                
                try {
                    let js = trimmedText.trim();
                    
                    // Chu·∫©n h√≥a code
                    console.log('üîß Chu·∫©n h√≥a code...');
                    
                    // X√≥a d·∫•u ch·∫•m ph·∫©y v√† ngo·∫∑c vu√¥ng th·ª´a ·ªü cu·ªëi
                    js = js.replace(/\]\s*;?\s*$/g, '');  // X√≥a ]; ho·∫∑c ] ·ªü cu·ªëi
                    js = js.replace(/;+\s*$/g, '');       // X√≥a ; ·ªü cu·ªëi
                    
                    // X√≥a d·∫•u ph·∫©y th·ª´a cu·ªëi m·∫£ng/object
                    js = js.replace(/,(\s*[\]}])/g, '$1');
                    
                    // Th√™m d·∫•u ph·∫©y thi·∫øu gi·ªØa c√°c object
                    js = js.replace(/\}\s*\{/g, '},{');
                    
                    // Wrap th√†nh array n·∫øu ch∆∞a c√≥
                    if (!js.startsWith('[')) {
                        console.log('üì¶ Wrap th√†nh array...');
                        js = '[' + js;
                    }
                    
                    // ƒê√≥ng ngo·∫∑c vu√¥ng n·∫øu thi·∫øu
                    if (!js.endsWith(']')) {
                        js = js + ']';
                    }
                    
                    // X·ª≠ l√Ω d·∫•u ngo·∫∑c k√©p trong string
                    js = js.replace(/(['"])(.*?)\1/g, function(match, quote, content) {
                        // Escape c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát trong string
                        return quote + content + quote;
                    });
                    
                    console.log('üöÄ ƒêang parse...');
                    let parsed = eval('(' + js + ')');
                    
                    console.log('üì¶ K·∫øt qu·∫£ parse:', parsed.length, 'c√¢u');
                    if (parsed.length > 0) {
                        console.log('üîç C√¢u ƒë·∫ßu ti√™n:', JSON.stringify(parsed[0], null, 2));
                    }
                    
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        console.log('‚úÖ Th√†nh c√¥ng! Parsed ' + parsed.length + ' c√¢u h·ªèi');
                        return addOriginalIndex(parsed);
                    }
                } catch (e) {
                    console.error('‚ùå L·ªói eval():', e.message);
                    console.log('üîÑ Th·ª≠ ph∆∞∆°ng ph√°p d·ª± ph√≤ng...');
                    
                    // Ph∆∞∆°ng ph√°p d·ª± ph√≤ng: Parse t·ª´ng object ri√™ng l·∫ª
                    try {
                        const objects = [];
                        const regex = /\{\s*type:\s*['"]mc['"],[\s\S]*?\}/g;
                        const tfRegex = /\{\s*type:\s*['"]tf['"],[\s\S]*?\]\s*\}/g;
                        
                        let matches = trimmedText.match(regex) || [];
                        let tfMatches = trimmedText.match(tfRegex) || [];
                        
                        console.log('üìä T√¨m th·∫•y ' + matches.length + ' MC + ' + tfMatches.length + ' TF');
                        
                        [...matches, ...tfMatches].forEach((objStr, idx) => {
                            try {
                                // Chu·∫©n h√≥a t·ª´ng object
                                objStr = objStr.replace(/,(\s*[\]}])/g, '$1');
                                const obj = eval('(' + objStr + ')');
                                objects.push(obj);
                            } catch (err) {
                                console.warn('‚ö†Ô∏è B·ªè qua object #' + (idx+1) + ':', err.message);
                            }
                        });
                        
                        if (objects.length > 0) {
                            console.log('‚úÖ Parsed ' + objects.length + ' c√¢u qua ph∆∞∆°ng ph√°p d·ª± ph√≤ng');
                            return addOriginalIndex(objects);
                        }
                    } catch (fallbackErr) {
                        console.error('‚ùå Ph∆∞∆°ng ph√°p d·ª± ph√≤ng th·∫•t b·∫°i:', fallbackErr.message);
                    }
                    
                    alert('‚ùå Kh√¥ng th·ªÉ parse!\n\n' + e.message + '\n\nVui l√≤ng:\n1. M·ªü Console (F12)\n2. Ki·ªÉm tra l·ªói chi ti·∫øt\n3. S·ª≠a c√∫ ph√°p JavaScript');
                    return [];
                }
            }
            
            // Text format fallback
            console.log('üìù Th·ª≠ parse text format...');
            
            // T√°ch c√¢u h·ªèi d·ª±a tr√™n pattern "s·ªë. C√¢u s·ªë."
            const questionPattern = /(\d+\.\s*C√¢u\s*\d+\..*?)(?=\d+\.\s*C√¢u\s*\d+\.|$)/gs;
            let textMatches = text.match(questionPattern);
            
            if (!textMatches) {
                // Fallback: t√°ch theo d√≤ng tr·ªëng
                textMatches = text.split(/\n\s*\n+/).filter(b => b.trim());
            }
            
            console.log('üìä T√¨m th·∫•y', textMatches ? textMatches.length : 0, 'block text');
            
            const questions = [];

            (textMatches || []).forEach((block, blockIdx) => {
                console.log(`\nüîç Block ${blockIdx + 1}:`, block.substring(0, 100));
                
                const lines = block.split('\n').map(l => l.trim()).filter(l => l);
                if (lines.length === 0) return;

                // KH√îNG X√ìA S·ªê N·ªÆA - gi·ªØ nguy√™n c√¢u h·ªèi
                let question = lines[0];  // GI·ªÆ NGUY√äN
                
                // T√°ch c√¢u h·ªèi v√† ƒë√°p √°n d·ª±a tr√™n uppercase letters li√™n ti·∫øp
                const optionsMatch = block.match(/([A-D][^A-D]+)/g);
                
                if (optionsMatch && optionsMatch.length >= 2) {
                    const options = optionsMatch.map(o => o.trim());
                    // ƒê√°p √°n ƒë·∫ßu ti√™n (gi·∫£ ƒë·ªãnh)
                    const answer = options[0];
                    
                    console.log('‚úÖ T√¨m th·∫•y MC:', question);
                    console.log('   Options:', options.length);
                    
                    questions.push({ type: 'mc', question, options, answer });
                }
                
                const hasStmt = lines.some(l => /^[a-z][\.\)]\s*.+\((ƒê√∫ng|Sai)\)/i.test(l));
                const hasAns = lines.some(l => /^(ƒê√°p √°n|Answer):/i.test(l));
                const hasOpt = lines.some(l => /^[A-D][\.\)]\s+/i.test(l));

                if (hasStmt) {
                    const statements = [];
                    lines.slice(1).forEach(line => {
                        const m = line.match(/^[a-z][\.\)]\s*(.+?)\s*\((ƒê√∫ng|Sai)\)/i);
                        if (m) {
                            statements.push({
                                text: m[1].trim(),
                                answer: m[2].toLowerCase() === 'ƒë√∫ng'
                            });
                        }
                    });
                    if (statements.length > 0) {
                        questions.push({ type: 'tf', question, statements });
                    }
                } else if (hasOpt && hasAns) {
                    const options = [];
                    let answerText = '';
                    lines.slice(1).forEach(line => {
                        const om = line.match(/^([A-D])[\.\)]\s+(.+)/i);
                        if (om) options.push(om[2].trim());
                        const am = line.match(/^(ƒê√°p √°n|Answer):\s*(.+)/i);
                        if (am) answerText = am[2].trim();
                    });
                    let answer = answerText;
                    const al = answerText.match(/^([A-D])/i);
                    if (al) {
                        const idx = al[1].toUpperCase().charCodeAt(0) - 65;
                        answer = options[idx] || answerText;
                    }
                    if (options.length > 0) {
                        questions.push({ type: 'mc', question, options, answer });
                    }
                } else {
                    questions.push({ type: 'short', question, keywords: [], explanation: 'T·ª± lu·∫≠n' });
                }
            });

            return questions;
        }

        function renderWrongHistory() {
            const container = document.getElementById('wrong-container');
            container.innerHTML = '';
            document.getElementById('wrong-count').textContent = wrongHistory.size;
            
            if (wrongHistory.size === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 italic">Tuy·ªát v·ªùi! B·∫°n ch∆∞a l√†m sai c√¢u n√†o.</p>';
                return;
            }

            Array.from(wrongHistory).forEach(idx => {
                const q = quizData[idx];
                if (!q) return;

                const card = document.createElement('div');
                card.className = 'quiz-card';
                
                const title = document.createElement('h3');
                title.className = 'text-xl font-semibold mb-4 text-gray-800';
                title.textContent = q.question;
                card.appendChild(title);

                if (q.type === 'mc') {
                    q.options.forEach(opt => {
                        const div = document.createElement('div');
                        div.className = 'p-3 border rounded-lg mb-2';
                        if (opt === q.answer) {
                            div.className += ' border-green-500 bg-green-50 font-semibold text-green-900';
                            div.innerHTML = `‚úì ${opt}`;
                        } else {
                            div.textContent = opt;
                        }
                        card.appendChild(div);
                    });
                } else if (q.type === 'tf') {
                    q.statements.forEach(s => {
                        const div = document.createElement('div');
                        div.className = 'p-3 border rounded-lg mb-2';
                        div.innerHTML = `<strong>${s.text}:</strong> ${s.answer ? '‚úì ƒê√∫ng' : '‚úó Sai'}`;
                        card.appendChild(div);
                    });
                }
                
                container.appendChild(card);
            });
        }

        function renderRedoQuiz() {
            const container = document.getElementById('quiz-container-redo');
            container.innerHTML = '';
            
            // L·∫•y c√¢u sai v√† s·∫Øp x·∫øp theo th·ª© t·ª± ban ƒë·∫ßu (originalIndex)
            const redoData = quizData
                .map((q, idx) => ({...q, currentIndex: idx}))
                .filter((q) => wrongHistory.has(q.currentIndex))
                .sort((a, b) => a.originalIndex - b.originalIndex); // S·∫Øp x·∫øp theo th·ª© t·ª± g·ªëc
            
            if (redoData.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 italic">Ch∆∞a c√≥ c√¢u sai ƒë·ªÉ l√†m l·∫°i.</p>';
                return;
            }

            redoQuiz = {
                data: JSON.parse(JSON.stringify(redoData)),
                originalData: JSON.parse(JSON.stringify(redoData)), // L∆∞u b·∫£n g·ªëc ƒë·ªÉ reset
                status: new Array(redoData.length).fill(null),
                score: 0
            };

            redoQuiz.data.forEach((q, i) => {
                const card = document.createElement('div');
                card.className = 'quiz-card';
                
                const title = document.createElement('h3');
                title.className = 'text-xl font-semibold mb-4 text-gray-800';
                title.textContent = q.question;
                card.appendChild(title);

                if (q.type === 'mc') {
                    q.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.textContent = opt;
                        btn.className = 'option-btn w-full text-left p-4 my-2 rounded-lg border border-gray-300 hover:bg-gray-100';
                        btn.onclick = () => {
                            if (redoQuiz.status[i] !== null) return;
                            card.querySelectorAll('.option-btn').forEach(b => {
                                b.disabled = true;
                                if (b.textContent === q.answer) b.classList.add('correct');
                            });
                            if (opt === q.answer) {
                                btn.classList.add('correct');
                                redoQuiz.status[i] = 'correct';
                                redoQuiz.score++;
                            } else {
                                btn.classList.add('incorrect');
                                redoQuiz.status[i] = 'incorrect';
                            }
                            updateRedoProgress();
                        };
                        card.appendChild(btn);
                    });
                } else if (q.type === 'tf') {
                    q.statements.forEach((s, si) => {
                        const g = document.createElement('div');
                        g.className = 'p-4 border rounded-lg mb-3';
                        g.innerHTML = `<p class="mb-3 font-medium">${s.text}</p>
                        <div class="flex gap-4">
                            <input type="radio" id="redo-tf-${i}-${si}-t" name="redo-tf-${i}-${si}" value="true" class="tf-input">
                            <label for="redo-tf-${i}-${si}-t" class="tf-label">ƒê√∫ng</label>
                            <input type="radio" id="redo-tf-${i}-${si}-f" name="redo-tf-${i}-${si}" value="false" class="tf-input">
                            <label for="redo-tf-${i}-${si}-f" class="tf-label">Sai</label>
                        </div>`;
                        card.appendChild(g);
                    });
                    const btn = document.createElement('button');
                    btn.textContent = 'Ki·ªÉm tra';
                    btn.className = 'mt-4 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg';
                    btn.onclick = () => {
                        if (redoQuiz.status[i] !== null) return;
                        let ok = true;
                        q.statements.forEach((s, si) => {
                            const sel = card.querySelector(`input[name='redo-tf-${i}-${si}']:checked`);
                            const tl = card.querySelector(`label[for='redo-tf-${i}-${si}-t']`);
                            const fl = card.querySelector(`label[for='redo-tf-${i}-${si}-f']`);
                            if (s.answer) {
                                tl.classList.add('correct');
                                if (sel && sel.value === 'false') { fl.classList.add('incorrect'); ok = false; }
                            } else {
                                fl.classList.add('correct');
                                if (sel && sel.value === 'true') { tl.classList.add('incorrect'); ok = false; }
                            }
                        });
                        redoQuiz.status[i] = ok ? 'correct' : 'incorrect';
                        if (ok) redoQuiz.score++;
                        btn.style.display = 'none';
                        updateRedoProgress();
                    };
                    card.appendChild(btn);
                }
                
                container.appendChild(card);
            });

            updateRedoProgress();
        }

        function updateRedoProgress() {
            if (!redoQuiz) return;
            const done = redoQuiz.status.filter(s => s !== null).length;
            const wrong = redoQuiz.status.filter(s => s === 'incorrect').length;
            document.getElementById('progress-text-redo').textContent = `ƒê√£ ho√†n th√†nh: ${done} / ${redoQuiz.data.length} | C√¢u sai: ${wrong}`;
        }

        function renderQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            if (quizData.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 italic">Ch∆∞a c√≥ c√¢u h·ªèi.</p>';
                return;
            }
            
            // Load ti·∫øn ƒë·ªô ƒë√£ l∆∞u
            const savedProgress = localStorage.getItem('quizProgress');
            const savedAnswers = localStorage.getItem('selectedAnswers');
            
            if (savedProgress) {
                questionStatus = JSON.parse(savedProgress);
                console.log('üì• ƒê√£ load ti·∫øn ƒë·ªô:', questionStatus.length, 'c√¢u');
            } else {
                questionStatus = new Array(quizData.length).fill(null);
            }
            
            if (savedAnswers) {
                selectedAnswers = JSON.parse(savedAnswers);
                console.log('üì• ƒê√£ load ƒë√°p √°n:', selectedAnswers.length, 'c√¢u');
            } else {
                selectedAnswers = new Array(quizData.length).fill(null);
            }
            
            quizData.forEach((q, i) => {
                const card = document.createElement('div');
                card.className = 'quiz-card';
                const title = document.createElement('h3');
                title.className = 'text-xl font-semibold mb-4 text-gray-800';
                title.textContent = q.question;  // KH√îNG th√™m s·ªë n·ªØa
                card.appendChild(title);
                
                if (q.type === 'mc') {
                    q.options.forEach(opt => {
                        const btn = document.createElement('button');
                        btn.textContent = opt;
                        btn.className = 'option-btn w-full text-left p-4 my-2 rounded-lg border border-gray-300 hover:bg-gray-100';
                        
                        // KH√îI PH·ª§C TR·∫†NG TH√ÅI ƒê√É CH·ªåN
                        if (questionStatus[i] !== null) {
                            btn.disabled = true;
                            
                            // Hi·ªÉn th·ªã ƒë√°p √°n ƒë√∫ng (lu√¥n hi·ªán)
                            if (opt === q.answer) {
                                btn.classList.add('correct');
                            }
                            
                            // Hi·ªÉn th·ªã ƒë√°p √°n ƒë√£ ch·ªçn SAI (ch·ªâ khi ch·ªçn sai)
                            if (opt === selectedAnswers[i] && opt !== q.answer) {
                                btn.classList.add('incorrect');
                            }
                        }
                        
                        btn.onclick = () => {
                            if (questionStatus[i] !== null) return;
                            card.querySelectorAll('.option-btn').forEach(b => {
                                b.disabled = true;
                                if (b.textContent === q.answer) b.classList.add('correct');
                            });
                            
                            // L∆ØU ƒê√ÅP √ÅN ƒê√É CH·ªåN
                            selectedAnswers[i] = opt;
                            
                            if (opt === q.answer) {
                                btn.classList.add('correct');
                                questionStatus[i] = 'correct';
                            } else {
                                btn.classList.add('incorrect');
                                questionStatus[i] = 'incorrect';
                                wrongHistory.add(i); // Th√™m v√†o l·ªãch s·ª≠ sai
                                localStorage.setItem('wrongHistory', JSON.stringify(Array.from(wrongHistory)));
                            }
                            updateProgress();
                        };
                        card.appendChild(btn);
                    });
                } else if (q.type === 'tf') {
                    q.statements.forEach((s, si) => {
                        const g = document.createElement('div');
                        g.className = 'p-4 border rounded-lg mb-3';
                        g.innerHTML = `<p class="mb-3 font-medium">${s.text}</p>
                        <div class="flex gap-4">
                            <input type="radio" id="tf-${i}-${si}-t" name="tf-${i}-${si}" value="true" class="tf-input">
                            <label for="tf-${i}-${si}-t" class="tf-label">ƒê√∫ng</label>
                            <input type="radio" id="tf-${i}-${si}-f" name="tf-${i}-${si}" value="false" class="tf-input">
                            <label for="tf-${i}-${si}-f" class="tf-label">Sai</label>
                        </div>`;
                        card.appendChild(g);
                    });
                    const btn = document.createElement('button');
                    btn.textContent = 'Ki·ªÉm tra';
                    btn.className = 'mt-4 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg';
                    btn.onclick = () => {
                        if (questionStatus[i] !== null) return;
                        let ok = true;
                        q.statements.forEach((s, si) => {
                            const sel = card.querySelector(`input[name='tf-${i}-${si}']:checked`);
                            const tl = card.querySelector(`label[for='tf-${i}-${si}-t']`);
                            const fl = card.querySelector(`label[for='tf-${i}-${si}-f']`);
                            if (s.answer) {
                                tl.classList.add('correct');
                                if (sel && sel.value === 'false') { fl.classList.add('incorrect'); ok = false; }
                            } else {
                                fl.classList.add('correct');
                                if (sel && sel.value === 'true') { tl.classList.add('incorrect'); ok = false; }
                            }
                        });
                        questionStatus[i] = ok ? 'correct' : 'incorrect';
                        if (!ok) {
                            wrongHistory.add(i);
                            localStorage.setItem('wrongHistory', JSON.stringify(Array.from(wrongHistory)));
                        }
                        btn.style.display = 'none';
                        updateProgress();
                    };
                    card.appendChild(btn);
                } else {
                    const ta = document.createElement('textarea');
                    ta.className = 'w-full h-32 p-3 border rounded-lg';
                    card.appendChild(ta);
                    const btn = document.createElement('button');
                    btn.textContent = 'Ho√†n th√†nh';
                    btn.className = 'mt-4 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg';
                    btn.onclick = () => {
                        ta.disabled = true;
                        questionStatus[i] = 'completed';
                        btn.disabled = true;
                        updateProgress();
                    };
                    card.appendChild(btn);
                }
                container.appendChild(card);
            });
            
            // Kh√¥i ph·ª•c tr·∫°ng th√°i ƒë√£ tr·∫£ l·ªùi
            if (savedProgress) {
                quizData.forEach((q, i) => {
                    if (questionStatus[i] !== null) {
                        const card = container.children[i];
                        if (q.type === 'mc') {
                            const buttons = card.querySelectorAll('.option-btn');
                            buttons.forEach(btn => {
                                btn.disabled = true;
                                if (btn.textContent === q.answer) {
                                    btn.classList.add('correct');
                                }
                            });
                            if (questionStatus[i] === 'incorrect') {
                                // T√¨m n√∫t ƒë√£ ch·ªçn sai (c·∫ßn l∆∞u th√™m th√¥ng tin)
                                // T·∫°m th·ªùi ch·ªâ disable
                            }
                        }
                    }
                });
            }
            
            updateProgress();
        }

        function updateProgress() {
            const done = questionStatus.filter(s => s !== null).length;
            const wrong = questionStatus.filter(s => s === 'incorrect').length;
            document.getElementById('progress-text').textContent = `ƒê√£ ho√†n th√†nh: ${done} / ${quizData.length} | C√¢u sai: ${wrong}`;
            
            // L∆∞u ti·∫øn ƒë·ªô v√†o localStorage
            localStorage.setItem('quizProgress', JSON.stringify(questionStatus));
            localStorage.setItem('selectedAnswers', JSON.stringify(selectedAnswers));
            localStorage.setItem('wrongHistory', JSON.stringify(Array.from(wrongHistory)));
            console.log('üíæ ƒê√£ l∆∞u ti·∫øn ƒë·ªô');
        }

        document.getElementById('tab-input').onclick = () => {
            console.log('üîò Click tab: Input');
            showTab('input');
        };
        document.getElementById('tab-saved').onclick = () => {
            console.log('üîò Click tab: Saved');
            showTab('saved');
        };
        document.getElementById('tab-quiz').onclick = () => {
            console.log('üîò Click tab: Quiz');
            showTab('quiz');
        };
        document.getElementById('tab-wrong').onclick = () => {
            console.log('üîò Click tab: Wrong');
            showTab('wrong');
        };
        document.getElementById('tab-redo').onclick = () => {
            console.log('üîò Click tab: Redo');
            showTab('redo');
        };

        document.getElementById('btn-parse').onclick = () => {
            const text = document.getElementById('input-data').value;
            const subjectName = document.getElementById('subject-name').value.trim();
            
            if (!text.trim()) { 
                alert('Vui l√≤ng nh·∫≠p d·ªØ li·ªáu!'); 
                return; 
            }
            
            if (!subjectName) {
                alert('Vui l√≤ng nh·∫≠p t√™n m√¥n h·ªçc!');
                return;
            }
            
            console.log('üîÑ Parse d·ªØ li·ªáu m·ªõi...');
            quizData = parseQuizData(text);
            
            if (quizData.length === 0) { 
                alert('Kh√¥ng parse ƒë∆∞·ª£c! Xem Console (F12)'); 
                return; 
            }
            
            console.log('üíæ L∆∞u m√¥n h·ªçc:', subjectName);
            
            // L∆ØU V√ÄO DANH S√ÅCH C√ÅC M√îN
            const subjects = JSON.parse(localStorage.getItem('savedSubjects') || '{}');
            subjects[subjectName] = quizData;
            localStorage.setItem('savedSubjects', JSON.stringify(subjects));
            
            // T·ª∞ ƒê·ªòNG T·∫†O BACKUP
            autoBackup(subjects);
            
            // L∆ØU B·∫¢N G·ªêC ƒë·ªÉ reset sau n√†y (l∆∞u ri√™ng kh√¥ng b·ªã ghi ƒë√® khi shuffle)
            currentSubject = subjectName;
            originalQuizData = JSON.parse(JSON.stringify(quizData));
            localStorage.setItem('originalQuizData', JSON.stringify(originalQuizData));
            
            localStorage.setItem('quizData', JSON.stringify(quizData));
            localStorage.setItem('currentSubject', subjectName);
            
            // Reset ti·∫øn ƒë·ªô c≈©
            localStorage.removeItem('quizProgress');
            wrongHistory.clear();
            localStorage.removeItem('wrongHistory');
            
            const mc = quizData.filter(q => q.type === 'mc').length;
            const tf = quizData.filter(q => q.type === 'tf').length;
            const sh = quizData.filter(q => q.type === 'short').length;
            document.getElementById('parse-stats').textContent = `${quizData.length} c√¢u (${mc} MC, ${tf} TF, ${sh} Short)`;
            document.getElementById('parse-result').classList.remove('hidden');
            
            console.log('‚úÖ ƒê√£ l∆∞u! Chuy·ªÉn sang tab L√†m B√†i T·∫≠p...');
            setTimeout(() => { showTab('quiz'); renderQuiz(); }, 1000);
        };

        document.getElementById('btn-clear').onclick = () => {
            if (confirm('X√≥a?')) document.getElementById('input-data').value = '';
        };

        // ===== AUTO BACKUP =====
        function autoBackup(subjects) {
            const data = {
                subjects: subjects,
                lastUpdated: new Date().toISOString(),
                version: '1.0'
            };
            
            // L∆∞u timestamp
            localStorage.setItem('lastUpdated', data.lastUpdated);
            
            // L∆∞u v√†o localStorage
            localStorage.setItem('backupData', JSON.stringify(data));
            console.log('üíæ ƒê√£ t·ª± ƒë·ªông backup', Object.keys(subjects).length, 'm√¥n');
            
            // T·ª± ƒë·ªông c·∫≠p nh·∫≠t luudata.json
            updateLuudataJson(data);
        }
        
        async function updateLuudataJson(data) {
            // N·∫øu kh√¥ng c√≥ GitHub config, ch·ªâ t·∫£i file local
            if (!GITHUB_TOKEN || !GITHUB_REPO) {
                console.log('‚ö†Ô∏è Kh√¥ng c√≥ GitHub config - ch·ªâ l∆∞u localStorage');
                downloadJson(data);
                return;
            }
            
            try {
                console.log('üì§ ƒêang push l√™n GitHub...');
                
                // 1. L·∫•y SHA c·ªßa file hi·ªán t·∫°i (n·∫øu c√≥)
                const getUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/quiz-generator/luudata.json`;
                let sha = null;
                
                try {
                    const getResp = await fetch(getUrl, {
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (getResp.ok) {
                        const fileData = await getResp.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    console.log('üìù File ch∆∞a t·ªìn t·∫°i, s·∫Ω t·∫°o m·ªõi');
                }
                
                // 2. Push file m·ªõi
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const pushUrl = `https://api.github.com/repos/${GITHUB_REPO}/contents/quiz-generator/luudata.json`;
                
                const payload = {
                    message: `Auto update: ${Object.keys(data.subjects).length} m√¥n h·ªçc`,
                    content: content,
                    branch: GITHUB_BRANCH
                };
                
                if (sha) payload.sha = sha;
                
                const pushResp = await fetch(pushUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (pushResp.ok) {
                    console.log('‚úÖ ƒê√£ push l√™n GitHub!');
                } else {
                    const error = await pushResp.json();
                    console.error('‚ùå L·ªói push GitHub:', error.message);
                    downloadJson(data); // Fallback: t·∫£i file
                }
                
            } catch (error) {
                console.error('‚ùå L·ªói k·∫øt n·ªëi GitHub:', error);
                downloadJson(data); // Fallback: t·∫£i file
            }
        }
        
        function downloadJson(data) {
            // T·ª± ƒë·ªông t·∫£i file v·ªÅ m√°y
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'luudata.json';
            a.click();
            URL.revokeObjectURL(url);
            console.log('üíæ ƒê√£ t·∫£i file backup v·ªÅ m√°y');
        }
        
        document.getElementById('btn-backup').onclick = () => {
            const subjects = JSON.parse(localStorage.getItem('savedSubjects') || '{}');
            if (Object.keys(subjects).length === 0) {
                alert('Kh√¥ng c√≥ m√¥n n√†o ƒë·ªÉ backup!');
                return;
            }
            
            const data = {
                subjects: subjects,
                lastUpdated: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'luudata.json';
            a.click();
            URL.revokeObjectURL(url);
            
            console.log('üíæ ƒê√£ t·∫£i backup:', Object.keys(subjects).length, 'm√¥n');
            alert(`‚úÖ ƒê√£ t·∫£i file luudata.json (${Object.keys(subjects).length} m√¥n)`);
        };

        document.getElementById('btn-shuffle').onclick = () => {
            quizData.sort(() => Math.random() - 0.5);
            quizData.forEach(q => {
                if (q.type === 'mc' && q.options) {
                    q.options.sort(() => Math.random() - 0.5);
                }
            });
            
            // L∆ØU TR·∫†NG TH√ÅI ƒê√É X√ÅO TR·ªòN ƒë·ªÉ gi·ªØ khi reload
            localStorage.setItem('quizData', JSON.stringify(quizData));
            // KH√îNG l∆∞u v√†o originalQuizData (ƒë·ªÉ Reset v·∫´n v·ªÅ ƒë√∫ng th·ª© t·ª± ban ƒë·∫ßu)
            console.log('üîÄ ƒê√£ x√°o tr·ªôn v√† l∆∞u');
            
            renderQuiz();
        };

        document.getElementById('btn-reset').onclick = () => {
            if (confirm('Reset v·ªÅ th·ª© t·ª± ban ƒë·∫ßu v√† x√≥a to√†n b·ªô ti·∫øn ƒë·ªô?')) {
                // X√≥a ti·∫øn ƒë·ªô ƒë√£ l∆∞u
                localStorage.removeItem('quizProgress');
                localStorage.removeItem('selectedAnswers');
                console.log('üßπ ƒê√£ x√≥a ti·∫øn ƒë·ªô');
                
                // Kh√¥i ph·ª•c v·ªÅ d·ªØ li·ªáu g·ªëc t·ª´ localStorage (th·ª© t·ª± ban ƒë·∫ßu khi parse)
                const originalData = localStorage.getItem('originalQuizData');
                if (originalData) {
                    quizData = JSON.parse(originalData);
                    originalQuizData = JSON.parse(originalData);
                    console.log('‚úÖ ƒê√£ reset v·ªÅ th·ª© t·ª± ban ƒë·∫ßu');
                } else {
                    // Fallback: d√πng originalQuizData hi·ªán t·∫°i
                    quizData = JSON.parse(JSON.stringify(originalQuizData));
                    console.log('‚ö†Ô∏è D√πng originalQuizData backup');
                }
                
                // L∆∞u l·∫°i quizData (ƒë√£ reset)
                localStorage.setItem('quizData', JSON.stringify(quizData));
                
                // Reset questionStatus
                questionStatus = new Array(quizData.length).fill(null);
                selectedAnswers = new Array(quizData.length).fill(null);
                
                // Render l·∫°i t·ª´ ƒë·∫ßu
                renderQuiz();
            }
        };

        document.getElementById('btn-clear-history').onclick = () => {
            if (confirm('X√≥a to√†n b·ªô l·ªãch s·ª≠ c√¢u sai?')) {
                wrongHistory.clear();
                localStorage.removeItem('wrongHistory');
                renderWrongHistory();
                renderRedoQuiz(); // T·ª± ƒë·ªông c·∫≠p nh·∫≠t tab "L√†m L·∫°i C√¢u Sai"
            }
        };

        document.getElementById('btn-shuffle-redo').onclick = () => {
            if (redoQuiz && redoQuiz.data) {
                // X√°o tr·ªôn nh∆∞ng v·∫´n gi·ªØ originalData ƒë·ªÉ reset v·ªÅ ban ƒë·∫ßu
                redoQuiz.data.sort(() => Math.random() - 0.5);
                redoQuiz.data.forEach(q => {
                    if (q.type === 'mc' && q.options) {
                        q.options.sort(() => Math.random() - 0.5);
                    }
                });
                
                // Render l·∫°i v·ªõi data ƒë√£ x√°o tr·ªôn
                const container = document.getElementById('quiz-container-redo');
                container.innerHTML = '';
                redoQuiz.status = new Array(redoQuiz.data.length).fill(null);
                redoQuiz.score = 0;
                
                redoQuiz.data.forEach((q, i) => {
                    const card = document.createElement('div');
                    card.className = 'quiz-card';
                    
                    const title = document.createElement('h3');
                    title.className = 'text-xl font-semibold mb-4 text-gray-800';
                    title.textContent = q.question;
                    card.appendChild(title);

                    if (q.type === 'mc') {
                        q.options.forEach(opt => {
                            const btn = document.createElement('button');
                            btn.textContent = opt;
                            btn.className = 'option-btn w-full text-left p-4 my-2 rounded-lg border border-gray-300 hover:bg-gray-100';
                            btn.onclick = () => {
                                if (redoQuiz.status[i] !== null) return;
                                card.querySelectorAll('.option-btn').forEach(b => {
                                    b.disabled = true;
                                    if (b.textContent === q.answer) b.classList.add('correct');
                                });
                                if (opt === q.answer) {
                                    btn.classList.add('correct');
                                    redoQuiz.status[i] = 'correct';
                                    redoQuiz.score++;
                                } else {
                                    btn.classList.add('incorrect');
                                    redoQuiz.status[i] = 'incorrect';
                                }
                                updateRedoProgress();
                            };
                            card.appendChild(btn);
                        });
                    } else if (q.type === 'tf') {
                        q.statements.forEach((s, si) => {
                            const g = document.createElement('div');
                            g.className = 'p-4 border rounded-lg mb-3';
                            g.innerHTML = `<p class="mb-3 font-medium">${s.text}</p>
                            <div class="flex gap-4">
                                <input type="radio" id="redo-tf-${i}-${si}-t" name="redo-tf-${i}-${si}" value="true" class="tf-input">
                                <label for="redo-tf-${i}-${si}-t" class="tf-label">ƒê√∫ng</label>
                                <input type="radio" id="redo-tf-${i}-${si}-f" name="redo-tf-${i}-${si}" value="false" class="tf-input">
                                <label for="redo-tf-${i}-${si}-f" class="tf-label">Sai</label>
                            </div>`;
                            card.appendChild(g);
                        });
                        const btn = document.createElement('button');
                        btn.textContent = 'Ki·ªÉm tra';
                        btn.className = 'mt-4 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg';
                        btn.onclick = () => {
                            if (redoQuiz.status[i] !== null) return;
                            let ok = true;
                            q.statements.forEach((s, si) => {
                                const sel = card.querySelector(`input[name='redo-tf-${i}-${si}']:checked`);
                                const tl = card.querySelector(`label[for='redo-tf-${i}-${si}-t']`);
                                const fl = card.querySelector(`label[for='redo-tf-${i}-${si}-f']`);
                                if (s.answer) {
                                    tl.classList.add('correct');
                                    if (sel && sel.value === 'false') { fl.classList.add('incorrect'); ok = false; }
                                } else {
                                    fl.classList.add('correct');
                                    if (sel && sel.value === 'true') { tl.classList.add('incorrect'); ok = false; }
                                }
                            });
                            redoQuiz.status[i] = ok ? 'correct' : 'incorrect';
                            if (ok) redoQuiz.score++;
                            btn.style.display = 'none';
                            updateRedoProgress();
                        };
                        card.appendChild(btn);
                    }
                    
                    container.appendChild(card);
                });
                
                updateRedoProgress();
            }
        };

        document.getElementById('btn-reset-redo').onclick = () => {
            if (confirm('Reset v·ªÅ th·ª© t·ª± ban ƒë·∫ßu?')) {
                // Reset v·ªÅ data g·ªëc (th·ª© t·ª± ban ƒë·∫ßu ch∆∞a x√°o tr·ªôn)
                if (redoQuiz && redoQuiz.originalData) {
                    redoQuiz.data = JSON.parse(JSON.stringify(redoQuiz.originalData));
                }
                renderRedoQuiz();
            }
        };

        // ===== SYNC T·ª™ GITHUB =====
        async function syncFromGitHub() {
            if (!GITHUB_REPO) {
                console.log('‚ö†Ô∏è Kh√¥ng c√≥ GitHub config - b·ªè qua sync');
                return;
            }
            
            try {
                console.log('üì• ƒêang t·∫£i d·ªØ li·ªáu t·ª´ GitHub...');
                const url = `https://raw.githubusercontent.com/${GITHUB_REPO}/${GITHUB_BRANCH}/quiz-generator/luudata.json`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    console.log('‚ö†Ô∏è File luudata.json ch∆∞a t·ªìn t·∫°i tr√™n GitHub');
                    return;
                }
                
                const data = await response.json();
                const githubSubjects = data.subjects || {};
                const localSubjects = JSON.parse(localStorage.getItem('savedSubjects') || '{}');
                
                // So s√°nh v√† merge
                const githubCount = Object.keys(githubSubjects).length;
                const localCount = Object.keys(localSubjects).length;
                
                console.log('üìä GitHub:', githubCount, 'm√¥n | localStorage:', localCount, 'm√¥n');
                
                if (githubCount > localCount) {
                    // GitHub c√≥ nhi·ªÅu h∆°n ‚Üí Update localStorage
                    localStorage.setItem('savedSubjects', JSON.stringify(githubSubjects));
                    console.log('‚úÖ ƒê√£ sync', githubCount, 'm√¥n t·ª´ GitHub ‚Üí localStorage');
                } else if (githubCount < localCount) {
                    // localStorage nhi·ªÅu h∆°n ‚Üí Push l√™n GitHub
                    console.log('ÔøΩ localStorage m·ªõi h∆°n, s·∫Ω push l√™n GitHub');
                    autoBackup(localSubjects);
                } else {
                    // Ki·ªÉm tra lastUpdated
                    const githubTime = new Date(data.lastUpdated || 0);
                    const localTime = new Date(localStorage.getItem('lastUpdated') || 0);
                    
                    if (githubTime > localTime) {
                        localStorage.setItem('savedSubjects', JSON.stringify(githubSubjects));
                        console.log('‚úÖ GitHub m·ªõi h∆°n, ƒë√£ sync xu·ªëng');
                    } else {
                        console.log('‚úÖ localStorage ƒë√£ l√† m·ªõi nh·∫•t');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå L·ªói sync t·ª´ GitHub:', error.message);
            }
        }

        window.onload = async () => {
            console.log('ÔøΩüöÄ ========== APP STARTED ==========');
            
            // SYNC T·ª™ GITHUB TR∆Ø·ªöC
            await syncFromGitHub();
            
            // Load d·ªØ li·ªáu t·ª´ localStorage
            const saved = localStorage.getItem('quizData');
            const savedWrong = localStorage.getItem('wrongHistory');
            const savedSubjectName = localStorage.getItem('currentSubject');
            const savedSubjects = localStorage.getItem('savedSubjects');
            
            console.log('üíæ localStorage contents:');
            console.log('  - quizData:', saved ? 'C√ì' : 'KH√îNG');
            console.log('  - wrongHistory:', savedWrong ? 'C√ì' : 'KH√îNG');
            console.log('  - currentSubject:', savedSubjectName || 'KH√îNG');
            console.log('  - savedSubjects:', savedSubjects ? 'C√ì' : 'KH√îNG');
            
            if (savedSubjects) {
                const subjects = JSON.parse(savedSubjects);
                console.log('üìö C√°c m√¥n ƒë√£ l∆∞u:', Object.keys(subjects));
            }
            
            if (savedWrong) {
                wrongHistory = new Set(JSON.parse(savedWrong));
                console.log('üì• Load l·ªãch s·ª≠ sai:', wrongHistory.size, 'c√¢u');
            }
            
            if (saved) {
                // Load t·ª´ localStorage - GI·ªÆ NGUY√äN ti·∫øn ƒë·ªô
                quizData = JSON.parse(saved);
                
                // Load b·∫£n g·ªëc t·ª´ localStorage ri√™ng (kh√¥ng copy t·ª´ quizData ƒë√£ shuffle)
                const savedOriginal = localStorage.getItem('originalQuizData');
                if (savedOriginal) {
                    originalQuizData = JSON.parse(savedOriginal);
                    console.log('‚úÖ Load originalQuizData t·ª´ localStorage');
                } else {
                    // Fallback: copy t·ª´ quizData (n·∫øu ch∆∞a t·ª´ng l∆∞u original)
                    originalQuizData = JSON.parse(JSON.stringify(quizData));
                    localStorage.setItem('originalQuizData', JSON.stringify(originalQuizData));
                    console.log('‚ö†Ô∏è Kh√¥ng c√≥ originalQuizData, copy t·ª´ quizData');
                }
                
                currentSubject = savedSubjectName || 'Kh√¥ng r√µ';
                
                console.log('üì¶ Load m√¥n:', currentSubject, '(' + quizData.length, 'c√¢u)');
                
                if (quizData.length > 0) { 
                    showTab('quiz'); 
                }
            } else {
                console.log('‚úÖ S·∫µn s√†ng! Nh·∫≠p d·ªØ li·ªáu m·ªõi v√†o tab "Nh·∫≠p D·ªØ Li·ªáu"');
            }
            
            console.log('‚úÖ ========== READY ==========');
        };
    </script>
</body>
</html>
